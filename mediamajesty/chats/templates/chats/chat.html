{% extends 'core/base.html' %}

{% block title %}Chat {{partner}}{% endblock %}

{% block content %}
This is {{user}}'s chat about {{ conversation.item }} with {{ partner }}

<div class="p-10 lg:p-20 text-center">
    <h1 class="text-2xl" id="coversation-item">{{ conversation.item }}</h1>
</div>

<div class="lg:w-2/4 mx-4 lg:mx-auto p-4 bg-gray-100 rounded-xl">
    <div class="chat-messages space-y-3" id="chat-messages">
        {% if messages %}
        {% for m in messages %}
        <p>
            <b>{{ m.sender }}</b>: {{ m.content }}
        </p>
        {% endfor %}
        {% else %}
        <p class="text-center" id="no-message-box">No messages sent to {{partner}} yet...</p>
        {% endif %}
    </div>
</div>

<div class="lg:w-2/4 mt-6 mx-4 lg:mx-auto p-4 bg-white rounded-xl">

    {% if request.user == conversation.buyer %}
    <button class="w-full mb-4 px-4 py-3 rounded-lg text-white bg-blue-500 hover:bg-blue-700">Make an offer</button>
    {% endif %}
    <form method="post" action="." class="flex" autocomplete="off">
        {% csrf_token %}
        <input type="text" name="content" class="flex-1 mr-3 p-4 border rounded-md" placeholder="Your message..."
            id="chat-message-input">

        <button class="px-5 py-3 rounded-md text-white bg-teal-600 hover:bg-teal-700"
            id="chat-message-submit">Send</button>
    </form>
    {{ conversation.id|json_script:"roomname" }}
    {{ user.username|json_script:"username" }}
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatMessageSubmit = document.getElementById('chat-message-submit');
    const chatMessageInput = document.getElementById('chat-message-input');
    const chatMessages = document.getElementById('chat-messages');
    const roomName = JSON.parse(document.getElementById('roomname').textContent);
    const userName = JSON.parse(document.getElementById('username').textContent);
    chatMessageInput.focus();

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = (e) => {
        if (document.getElementById('no-message-box')) {
            document.getElementById('no-message-box').remove();
        }
        if (chatMessages.children.length >= 10) {
            chatMessages.removeChild(chatMessages.children[0]);
        }
        const data = JSON.parse(e.data);
        const messageElement = document.createElement('p');
        messageElement.innerHTML = '<b>' + data['sender'] + '</b>: ' + data['message'];
        chatMessages.appendChild(messageElement);
    }

    chatSocket.onclose = (e) => {
        console.error('Chat socket closed unexpectedly');
    };

    chatMessageSubmit.onclick = (e) => {
        e.preventDefault();
        const message = chatMessageInput.value;
        chatSocket.send(JSON.stringify({
            'room': roomName,
            'sender': userName,
            'message': message,
        }));
        chatMessageInput.value = '';
    }
</script>
{% endblock %}
